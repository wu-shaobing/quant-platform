global:
  smtp_smarthost: 'localhost:587'
  smtp_from: 'alerts@quant-platform.com'
  smtp_auth_username: 'alerts@quant-platform.com'
  smtp_auth_password: 'your-email-password'

# å‘Šè­¦è·¯ç”±é…ç½®
route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'default-receiver'
  routes:
    # å…³é”®å‘Šè­¦ç«‹å³å‘é€
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 0s
      repeat_interval: 5m
    
    # äº¤æ˜“ç›¸å…³å‘Šè­¦
    - match:
        component: trading
      receiver: 'trading-alerts'
      group_wait: 30s
      repeat_interval: 15m
    
    # CTPè¿æ¥å‘Šè­¦
    - match:
        component: ctp
      receiver: 'ctp-alerts'
      group_wait: 30s
      repeat_interval: 10m
    
    # ç³»ç»Ÿèµ„æºå‘Šè­¦
    - match:
        component: system
      receiver: 'system-alerts'
      group_wait: 1m
      repeat_interval: 30m

# å‘Šè­¦æ¥æ”¶å™¨é…ç½®
receivers:
  # é»˜è®¤æ¥æ”¶å™¨
  - name: 'default-receiver'
    email_configs:
      - to: 'admin@quant-platform.com'
        subject: '[é‡åŒ–å¹³å°] {{ .GroupLabels.alertname }} å‘Šè­¦'
        body: |
          {{ range .Alerts }}
          å‘Šè­¦åç§°: {{ .Annotations.summary }}
          å‘Šè­¦æè¿°: {{ .Annotations.description }}
          å‘Šè­¦çº§åˆ«: {{ .Labels.severity }}
          ç»„ä»¶: {{ .Labels.component }}
          å¼€å§‹æ—¶é—´: {{ .StartsAt }}
          {{ if .EndsAt }}ç»“æŸæ—¶é—´: {{ .EndsAt }}{{ end }}
          
          æ ‡ç­¾:
          {{ range .Labels.SortedPairs }}  {{ .Name }}: {{ .Value }}
          {{ end }}
          {{ end }}
    
    webhook_configs:
      - url: 'http://quant-platform-backend:8000/api/v1/monitoring/alerts/webhook'
        send_resolved: true

  # å…³é”®å‘Šè­¦æ¥æ”¶å™¨
  - name: 'critical-alerts'
    email_configs:
      - to: 'admin@quant-platform.com,ops@quant-platform.com'
        subject: '[ç´§æ€¥] {{ .GroupLabels.alertname }} - é‡åŒ–å¹³å°å…³é”®å‘Šè­¦'
        body: |
          ğŸš¨ å…³é”®å‘Šè­¦ ğŸš¨
          
          {{ range .Alerts }}
          å‘Šè­¦åç§°: {{ .Annotations.summary }}
          å‘Šè­¦æè¿°: {{ .Annotations.description }}
          å‘Šè­¦çº§åˆ«: {{ .Labels.severity }}
          ç»„ä»¶: {{ .Labels.component }}
          å¼€å§‹æ—¶é—´: {{ .StartsAt }}
          
          å¤„ç†æ‰‹å†Œ: {{ .Annotations.runbook_url }}
          
          æ ‡ç­¾:
          {{ range .Labels.SortedPairs }}  {{ .Name }}: {{ .Value }}
          {{ end }}
          {{ end }}
    
    # é’‰é’‰é€šçŸ¥
    webhook_configs:
      - url: 'https://oapi.dingtalk.com/robot/send?access_token=YOUR_DINGTALK_TOKEN'
        send_resolved: true
        http_config:
          proxy_url: ''
        title: 'é‡åŒ–å¹³å°å…³é”®å‘Šè­¦'
        text: |
          ## ğŸš¨ å…³é”®å‘Šè­¦
          
          **å‘Šè­¦åç§°**: {{ .GroupLabels.alertname }}
          
          {{ range .Alerts }}
          **æè¿°**: {{ .Annotations.description }}
          **çº§åˆ«**: {{ .Labels.severity }}
          **ç»„ä»¶**: {{ .Labels.component }}
          **æ—¶é—´**: {{ .StartsAt }}
          {{ end }}

  # äº¤æ˜“å‘Šè­¦æ¥æ”¶å™¨
  - name: 'trading-alerts'
    email_configs:
      - to: 'trading@quant-platform.com'
        subject: '[äº¤æ˜“å‘Šè­¦] {{ .GroupLabels.alertname }}'
        body: |
          ğŸ’¹ äº¤æ˜“ç³»ç»Ÿå‘Šè­¦
          
          {{ range .Alerts }}
          å‘Šè­¦åç§°: {{ .Annotations.summary }}
          å‘Šè­¦æè¿°: {{ .Annotations.description }}
          å‘Šè­¦çº§åˆ«: {{ .Labels.severity }}
          å¼€å§‹æ—¶é—´: {{ .StartsAt }}
          
          {{ if .Labels.symbol }}äº¤æ˜“å“ç§: {{ .Labels.symbol }}{{ end }}
          {{ if .Labels.order_id }}è®¢å•ID: {{ .Labels.order_id }}{{ end }}
          {{ if .Labels.strategy_id }}ç­–ç•¥ID: {{ .Labels.strategy_id }}{{ end }}
          
          å¤„ç†æ‰‹å†Œ: {{ .Annotations.runbook_url }}
          {{ end }}

  # CTPè¿æ¥å‘Šè­¦æ¥æ”¶å™¨
  - name: 'ctp-alerts'
    email_configs:
      - to: 'ops@quant-platform.com'
        subject: '[CTPå‘Šè­¦] {{ .GroupLabels.alertname }}'
        body: |
          ğŸ”Œ CTPè¿æ¥å‘Šè­¦
          
          {{ range .Alerts }}
          å‘Šè­¦åç§°: {{ .Annotations.summary }}
          å‘Šè­¦æè¿°: {{ .Annotations.description }}
          è¿æ¥ç±»å‹: {{ .Labels.connection_type }}
          å‘Šè­¦çº§åˆ«: {{ .Labels.severity }}
          å¼€å§‹æ—¶é—´: {{ .StartsAt }}
          
          å¤„ç†æ‰‹å†Œ: {{ .Annotations.runbook_url }}
          {{ end }}

  # ç³»ç»Ÿèµ„æºå‘Šè­¦æ¥æ”¶å™¨
  - name: 'system-alerts'
    email_configs:
      - to: 'ops@quant-platform.com'
        subject: '[ç³»ç»Ÿå‘Šè­¦] {{ .GroupLabels.alertname }}'
        body: |
          ğŸ–¥ï¸ ç³»ç»Ÿèµ„æºå‘Šè­¦
          
          {{ range .Alerts }}
          å‘Šè­¦åç§°: {{ .Annotations.summary }}
          å‘Šè­¦æè¿°: {{ .Annotations.description }}
          å‘Šè­¦çº§åˆ«: {{ .Labels.severity }}
          å¼€å§‹æ—¶é—´: {{ .StartsAt }}
          
          å¤„ç†æ‰‹å†Œ: {{ .Annotations.runbook_url }}
          {{ end }}

# å‘Šè­¦æŠ‘åˆ¶è§„åˆ™
inhibit_rules:
  # å½“ç³»ç»Ÿå®•æœºæ—¶ï¼ŒæŠ‘åˆ¶å…¶ä»–æ‰€æœ‰å‘Šè­¦
  - source_match:
      alertname: SystemDown
    target_match_re:
      alertname: .*
    equal: ['instance']
  
  # å½“CTPè¿æ¥æ–­å¼€æ—¶ï¼ŒæŠ‘åˆ¶ç›¸å…³çš„äº¤æ˜“å‘Šè­¦
  - source_match:
      alertname: CTPConnectionDown
    target_match:
      component: trading
    equal: ['instance']
  
  # å½“æœ‰å…³é”®å‘Šè­¦æ—¶ï¼ŒæŠ‘åˆ¶åŒç±»å‹çš„è­¦å‘Šçº§åˆ«å‘Šè­¦
  - source_match:
      severity: critical
    target_match:
      severity: warning
    equal: ['alertname', 'instance']

# å‘Šè­¦æ¨¡æ¿
templates:
  - '/etc/alertmanager/templates/*.tmpl'
